<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAYORA | סיכומים ומשימות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #0a0a0a; color: #E0E0E0; }
        .bg-black-gradient { background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%); }
        .text-gold { color: #FFD700; }
        .border-gold { border-color: #FFD700; }
        .btn-gold {
            background-color: #FFD700; color: #111111;
            transition: all 0.3s ease;
        }
        .btn-gold:hover {
            background-color: #e6c200; transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #1a1a1a; border: 1px solid #FFD700; }
        .input-field, .select-field, .textarea-field {
            background-color: #2a2a2a; border: 1px solid #444; color: #E0E0E0;
            width: 100%; padding: 0.75rem; border-radius: 0.5rem;
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            outline: none; border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .task-item { transition: all 0.2s ease-in-out; }
        .task-item:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        .status-btn.selected {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
            border: 2px solid white;
        }
         .status-btn {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
    </style>
</head>
<body class="bg-black">

    <div id="app-container" class="hidden bg-black-gradient min-h-screen">
        <!-- Header -->
        <header class="bg-black/80 backdrop-blur-sm sticky top-0 z-40 shadow-lg shadow-gold/10">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                 <div class="flex items-center gap-3">
                    <img src="https://i.imgur.com/L1bxSUe.jpeg" alt="SAYORA Logo" class="w-10 h-10 rounded-full border border-gold">
                    <a href="#" class="text-2xl font-bold text-gold">SAYORA</a>
                </div>
                <div id="user-info" class="flex items-center gap-3">
                    <span id="welcome-msg" class="text-sm text-gray-300 hidden md:block"></span>
                    <button id="logout-btn" class="bg-transparent border border-gold text-gold py-1 px-3 rounded-md text-sm hover:bg-gold hover:text-black transition-colors">התנתקות</button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8">
                    <h1 class="text-3xl text-center sm:text-left sm:text-5xl font-bold text-gold">ניהול משימות</h1>
                    <button id="add-task-btn" class="btn-gold font-bold py-2 px-5 rounded-lg flex items-center gap-2 w-full sm:w-auto justify-center">
                        <i class="fas fa-plus-circle"></i>
                        <span>הוספת משימה</span>
                    </button>
                </div>
                
                <div id="checklist-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Tasks will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="task-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-md rounded-lg shadow-2xl shadow-gold/20">
            <form id="task-form" class="p-6 sm:p-8">
                <h2 id="task-modal-title" class="text-2xl sm:text-3xl font-bold text-gold mb-6 text-center">הוספת משימה</h2>
                <input type="hidden" id="task-id">
                
                <div id="task-page-1" class="space-y-5">
                    <div>
                        <label for="task-name" class="block text-sm font-medium text-gray-300 mb-1">שם המשימה</label>
                        <input type="text" id="task-name" class="input-field" required>
                        <p id="task-name-error" class="text-red-400 text-sm mt-1 hidden">שדה זה הוא חובה.</p>
                    </div>
                    <div>
                        <label for="task-urgency" class="block text-sm font-medium text-gray-300 mb-1">רמת דחיפות</label>
                        <select id="task-urgency" class="select-field">
                            <option value="1">1 - קריטי</option>
                            <option value="2">2 - גבוהה</option>
                            <option value="3" selected>3 - רגילה</option>
                            <option value="4">4 - נמוכה</option>
                            <option value="5">5 - נמוכה מאוד</option>
                        </select>
                    </div>
                    <div class="flex justify-between gap-4 pt-4">
                        <button type="button" id="cancel-task-btn-page1" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 w-1/2">ביטול</button>
                        <button type="button" id="next-task-page-btn" class="btn-gold font-bold py-2 px-6 rounded-lg w-1/2">הבא</button>
                    </div>
                </div>

                <div id="task-page-2" class="hidden space-y-5">
                    <div><label for="task-deadline" class="block text-sm font-medium text-gray-300 mb-1">דדליין</label><input type="text" id="task-deadline" class="input-field" placeholder="לדוגמא: ספטמבר 2025"></div>
                    <div><label for="task-contact" class="block text-sm font-medium text-gray-300 mb-1">איש קשר</label><input type="text" id="task-contact" class="input-field" placeholder="שם וטלפון (אופציונלי)"></div>
                    <div><label for="task-details" class="block text-sm font-medium text-gray-300 mb-1">פירוט נוסף</label><textarea id="task-details" rows="3" class="textarea-field"></textarea></div>
                    <div class="flex justify-between gap-4 pt-4">
                        <button type="button" id="back-task-page-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 w-1/2">חזור</button>
                        <button type="submit" class="btn-gold font-bold py-2 px-6 rounded-lg w-1/2">שמור</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="update-status-modal" class="fixed inset-0 z-[51] hidden items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-md rounded-lg shadow-2xl shadow-gold/20 max-h-[90vh] overflow-y-auto">
             <div class="p-6 sm:p-8">
                <h2 id="update-modal-title" class="text-2xl font-bold text-gold mb-4 text-center break-words"></h2>
                <div id="task-details-display" class="mb-4 p-3 bg-gray-800/50 rounded-lg space-y-1 text-xs border border-gray-700"></div>

                <div class="space-y-4 mb-4">
                    <div><label class="block text-sm font-medium text-gray-400 mb-1">סטטוס</label>
                        <div class="grid grid-cols-3 gap-2 sm:gap-4">
                            <button data-status="done" class="status-btn bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-500 flex items-center justify-center gap-2 text-sm"><i class="fas fa-check-circle"></i><span class="hidden sm:inline">בוצע</span></button>
                            <button data-status="progress" class="status-btn bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-500 flex items-center justify-center gap-2 text-sm"><i class="fas fa-tasks"></i><span class="hidden sm:inline">בתהליך</span></button>
                            <button data-status="" class="status-btn bg-red-700 text-white font-bold py-3 rounded-lg hover:bg-red-500 flex items-center justify-center gap-2 text-sm"><i class="fas fa-times-circle"></i><span class="hidden sm:inline">לא בוצע</span></button>
                        </div>
                    </div>
                     <div><label for="update-assigned-to" class="block text-sm font-medium text-gray-400">אחראי</label><input type="text" id="update-assigned-to" class="input-field mt-1"></div>
                     <div><label for="update-details" class="block text-sm font-medium text-gray-400">פירוט עדכון</label><textarea id="update-details" rows="2" class="textarea-field mt-1"></textarea></div>
                </div>
                
                <div class="space-y-3 mt-6">
                    <button type="button" id="save-update-btn" class="w-full btn-gold font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2"><i class="fas fa-save"></i><span>שמור שינויים</span></button>
                    <button type="button" id="edit-task-from-status-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-500 flex items-center justify-center gap-2"><i class="fas fa-edit"></i><span>ערוך משימה</span></button>
                    <button type="button" id="delete-task-btn" class="w-full bg-red-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2"><i class="fas fa-trash"></i><span>מחק משימה</span></button>
                    <button type="button" id="cancel-update-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 mt-4">סגור</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = { apiKey: "AIzaSyBK49YH2eqeTLhrvKgIsbg3r53-Wt4PmpQ", authDomain: "sayora-all.firebaseapp.com", projectId: "sayora-all", storageBucket: "sayora-all.appspot.com", messagingSenderId: "836076195583", appId: "1:836076195583:web:a7b0067b866d7e027a06ca", measurementId: "G-LFN43NSE5K" };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appContainer = document.getElementById('app-container');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeMsg = document.getElementById('welcome-msg');
        const checklistContainer = document.getElementById('checklist-container');
        const addTaskBtn = document.getElementById('add-task-btn');

        // Task Modal elements
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const taskModalTitle = document.getElementById('task-modal-title');
        const taskPage1 = document.getElementById('task-page-1');
        const taskPage2 = document.getElementById('task-page-2');
        const nextTaskPageBtn = document.getElementById('next-task-page-btn');
        const backTaskPageBtn = document.getElementById('back-task-page-btn');
        const cancelTaskBtnPage1 = document.getElementById('cancel-task-btn-page1');

        // Status Modal elements
        const updateStatusModal = document.getElementById('update-status-modal');
        const updateModalTitle = document.getElementById('update-modal-title');
        const editTaskFromStatusBtn = document.getElementById('edit-task-from-status-btn');
        const deleteTaskBtn = document.getElementById('delete-task-btn');
        const taskDetailsDisplay = document.getElementById('task-details-display');
        const saveUpdateBtn = document.getElementById('save-update-btn');
        const cancelUpdateBtn = document.getElementById('cancel-update-btn');
        let currentTaskIdForStatusUpdate = null;
        let selectedStatus = '';

        let tasks = [];

        onAuthStateChanged(auth, user => {
            if (user) {
                appContainer.classList.remove('hidden');
                welcomeMsg.textContent = `ברוך הבא, ${user.email.split('@')[0]}`;
                loadTasks();
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        function loadTasks() {
            const tasksRef = collection(db, 'checklistItems');
            onSnapshot(tasksRef, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks();
            });
        }

        function renderTasks() {
            checklistContainer.innerHTML = '';
            if (tasks.length === 0) {
                 checklistContainer.innerHTML = `<p class="text-gray-500 italic md:col-span-2 lg:col-span-3 text-center">אין משימות להצגה. לחץ על 'הוספת משימה' כדי להתחיל.</p>`;
                 return;
            }
            const sortedTasks = [...tasks].sort((a, b) => a.urgency - b.urgency || a.name.localeCompare(b.name, 'he'));
            sortedTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                checklistContainer.appendChild(taskElement);
            });
        }

        function getStatusInfo(status) {
            switch (status) {
                case 'done': return { text: 'בוצע', color: 'bg-green-600/80 border-green-400', icon: 'fa-check-circle' };
                case 'progress': return { text: 'בתהליך', color: 'bg-cyan-600/80 border-cyan-400', icon: 'fa-tasks' };
                default: return { text: 'לא בוצע', color: '', icon: 'fa-clock' };
            }
        }
        
        function getUrgencyColor(urgency, status) {
             if (status === 'done' || status === 'progress') return '';
            switch (parseInt(urgency)) {
                case 1: return 'bg-red-700/80 border-red-500';
                case 2: return 'bg-orange-600/80 border-orange-400';
                case 3: return 'bg-yellow-600/80 border-yellow-400';
                case 4: return 'bg-blue-600/80 border-blue-400';
                default: return 'bg-gray-700/80 border-gray-500';
            }
        }

        function createTaskElement(task) {
            const el = document.createElement('div');
            const statusInfo = getStatusInfo(task.status);
            const urgencyColor = getUrgencyColor(task.urgency, task.status);
            el.className = `task-item p-4 rounded-lg border-l-4 cursor-pointer flex flex-col justify-between bg-gray-800/40 ${statusInfo.color || urgencyColor}`;
            el.dataset.id = task.id;
            el.innerHTML = `
                <div>
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg sm:text-xl font-bold mb-2 break-words">${task.name}</h3>
                        <span class="text-xs font-bold py-1 px-2 rounded-full flex-shrink-0 ml-2 ${urgencyColor || 'bg-gray-600'}">${task.urgency}</span>
                    </div>
                    ${task.deadline ? `<p class="text-sm text-gray-300 mb-2"><i class="fas fa-calendar-alt fa-fw mr-2"></i>${task.deadline}</p>` : ''}
                    ${task.assignedTo ? `<p class="text-sm text-gray-200 font-semibold mb-2"><i class="fas fa-user-check fa-fw mr-2"></i>${task.assignedTo}</p>`: ''}
                </div>
                <div class="flex justify-start items-center gap-2 text-sm mt-3 pt-3 border-t border-white/20"><i class="fas ${statusInfo.icon} fa-fw"></i><span>${statusInfo.text}</span></div>`;
            el.addEventListener('click', () => openUpdateStatusModal(task.id));
            return el;
        }
        
        function openEditTaskModal(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            closeUpdateStatusModal();
            taskForm.reset();
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-deadline').value = task.deadline || '';
            document.getElementById('task-urgency').value = task.urgency;
            document.getElementById('task-contact').value = task.contact || '';
            document.getElementById('task-details').value = task.details || '';
            taskModalTitle.textContent = 'עריכת משימה';
            openTaskModal(0); 
        }

        editTaskFromStatusBtn.addEventListener('click', () => {
            if (currentTaskIdForStatusUpdate) openEditTaskModal(currentTaskIdForStatusUpdate);
        });

        deleteTaskBtn.addEventListener('click', async () => {
             if (currentTaskIdForStatusUpdate) {
                // A custom confirmation dialog would be better than window.confirm
                // For now, we proceed directly.
                await deleteDoc(doc(db, 'checklistItems', currentTaskIdForStatusUpdate));
                closeUpdateStatusModal();
            }
        });

        function openUpdateStatusModal(id) {
            currentTaskIdForStatusUpdate = id;
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            updateModalTitle.textContent = task.name;
            document.getElementById('update-assigned-to').value = task.assignedTo || '';
            document.getElementById('update-details').value = task.updateDetails || '';
            taskDetailsDisplay.innerHTML = `<p><strong class="text-gray-300">דדליין:</strong> ${task.deadline || 'לא הוגדר'}</p><p><strong class="text-gray-300">איש קשר:</strong> ${task.contact || 'לא הוגדר'}</p>`;
            
            selectedStatus = task.status || '';
            updateStatusButtonsUI();

            updateStatusModal.classList.remove('hidden');
            updateStatusModal.classList.add('flex');
        }
        
        function updateStatusButtonsUI() {
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.status === selectedStatus);
            });
        }

        updateStatusModal.querySelectorAll('.status-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedStatus = btn.dataset.status;
                updateStatusButtonsUI();
            });
        });

        saveUpdateBtn.addEventListener('click', async () => {
            if (!currentTaskIdForStatusUpdate) return;
            const assignedTo = document.getElementById('update-assigned-to').value;
            const updateDetails = document.getElementById('update-details').value;
            const taskRef = doc(db, 'checklistItems', currentTaskIdForStatusUpdate);
            await updateDoc(taskRef, { status: selectedStatus, assignedTo, updateDetails });
            closeUpdateStatusModal();
        });

        function openTaskModal(page = 0) {
            taskPage1.classList.toggle('hidden', page === 1);
            taskPage2.classList.toggle('hidden', page === 0);
            taskModal.classList.add('flex');
            taskModal.classList.remove('hidden');
        }

        addTaskBtn.addEventListener('click', () => {
            taskForm.reset();
            document.getElementById('task-id').value = '';
            taskModalTitle.textContent = 'הוספת משימה חדשה';
            openTaskModal(0);
        });

        taskForm.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('task-id').value;
            const taskData = {
                name: document.getElementById('task-name').value,
                urgency: parseInt(document.getElementById('task-urgency').value),
                deadline: document.getElementById('task-deadline').value,
                contact: document.getElementById('task-contact').value,
                details: document.getElementById('task-details').value,
            };
            
            if (id) {
                await updateDoc(doc(db, 'checklistItems', id), taskData);
            } else {
                taskData.status = ''; taskData.assignedTo = ''; taskData.updateDetails = '';
                await addDoc(collection(db, 'checklistItems'), taskData);
            }
            closeTaskModal();
        });

        nextTaskPageBtn.addEventListener('click', () => {
            const taskNameInput = document.getElementById('task-name');
            const errorEl = document.getElementById('task-name-error');
            if (taskNameInput.value.trim() === '') {
                taskNameInput.classList.add('border-red-500');
                errorEl.classList.remove('hidden');
                return;
            }
            taskNameInput.classList.remove('border-red-500');
            errorEl.classList.add('hidden');
            taskPage1.classList.add('hidden');
            taskPage2.classList.remove('hidden');
        });
        backTaskPageBtn.addEventListener('click', () => {
            taskPage2.classList.add('hidden');
            taskPage1.classList.remove('hidden');
        });
        
        function closeTaskModal() { taskModal.classList.add('hidden'); taskModal.classList.remove('flex'); }
        function closeUpdateStatusModal() { updateStatusModal.classList.add('hidden'); updateStatusModal.classList.remove('flex'); }

        cancelTaskBtnPage1.addEventListener('click', closeTaskModal);
        cancelUpdateBtn.addEventListener('click', closeUpdateStatusModal);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAYORA | סיכומים ומשימות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: #0a0a0a; 
            color: #E0E0E0;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 25px 25px;
        }
        .bg-black-gradient { background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%); }
        .text-gold { color: #FFD700; }
        .border-gold { border-color: #FFD700; }
        .btn-gold {
            background-color: #FFD700; color: #111111;
            transition: all 0.3s ease;
        }
        .btn-gold:hover {
            background-color: #e6c200; transform: scale(1.05) translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        #sidebar.open { transform: translateX(0); }
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.flex {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1a1a1a; 
            border: 1px solid #FFD700;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.flex .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        
        .input-field, .select-field, .textarea-field {
            background-color: #2a2a2a; border: 1px solid #444; color: #E0E0E0;
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; transition: all 0.2s ease;
        }
        .input-field:focus, .select-field:focus, .textarea-field:focus {
            outline: none; border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .task-item { transition: all 0.2s ease-in-out; }
        .task-item:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); border-color: #FFD700; }
        .status-btn.selected {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
            border: 2px solid white;
        }
         .status-btn {
            transition: all 0.2s ease;
             border: 2px solid transparent;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #FFD700; }
    </style>
</head>
<body class="bg-black">

    <div id="app-container" class="hidden bg-black-gradient">
        <!-- Header -->
        <header class="bg-black/80 backdrop-blur-sm sticky top-0 z-40 shadow-lg shadow-gold/10">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <button id="hamburger-btn" class="text-gold text-3xl p-2 lg:hidden">&#9776;</button>
                 <div class="flex items-center gap-3">
                    <img src="https://i.imgur.com/L1bxSUe.jpeg" alt="SAYORA Logo" class="w-10 h-10 rounded-full border-2 border-gold">
                    <a href="index.html" class="text-2xl font-bold text-gold">SAYORA</a>
                </div>
                <div id="user-info" class="flex items-center gap-3">
                    <span id="welcome-msg" class="text-sm text-gray-300 hidden md:block"></span>
                    <button id="logout-btn" class="bg-transparent border border-gold text-gold py-1 px-3 rounded-md text-sm hover:bg-gold hover:text-black transition-colors">התנתקות</button>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden"></div>
        <nav id="sidebar" class="fixed top-0 right-0 h-full w-64 bg-black-gradient shadow-2xl z-50 p-6 lg:hidden">
            <button id="close-sidebar-btn" class="absolute top-4 left-4 text-gray-400 text-2xl">&times;</button>
            <div class="mt-12 space-y-4 text-center">
                 <a href="festival-info.html" class="block py-2 px-4 rounded-md hover:bg-gold/10 text-lg">הסבר על הפסטיבל</a>
                <a href="costs.html" class="block py-2 px-4 rounded-md hover:bg-gold/10 text-lg">עלויות</a>
                <a href="suppliers.html" class="block py-2 px-4 rounded-md hover:bg-gold/10 text-lg">ספקים</a>
                <a href="map.html" class="block py-2 px-4 rounded-md hover:bg-gold/10 text-lg">מפת הפסטיבל</a>
                <a href="tickets.html" class="block py-2 px-4 rounded-md hover:bg-gold/10 text-lg">כרטיסים</a>
                <a href="summaries.html" class="block py-2 px-4 rounded-md bg-gold/20 text-white font-bold text-lg">סיכומים</a>
                <a href="user-management.html" class="block py-2 px-4 rounded-md hover:bg-gold/10 text-lg">ניהול משתמשים</a>
            </div>
        </nav>
        
        <!-- Main Content -->
        <div class="flex">
            <!-- Desktop Sidebar -->
            <aside class="w-64 bg-black p-6 hidden lg:block h-screen sticky top-0 shadow-lg shadow-black/50 border-l border-gray-800">
                <h2 class="text-xl font-semibold text-gold mb-6 border-b border-gold/20 pb-2">תפריט ניווט</h2>
                <nav class="space-y-2">
                    <a href="festival-info.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gold/20 text-gray-200">הסבר על הפסטיבל</a>
                    <a href="costs.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gold/20 text-gray-200">עלויות</a>
                    <a href="suppliers.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gold/20 text-gray-200">ספקים</a>
                    <a href="map.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gold/20 text-gray-200">מפת הפסטיבל</a>
                    <a href="tickets.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gold/20 text-gray-200">כרטיסים</a>
                    <a href="summaries.html" class="block py-2.5 px-4 rounded transition duration-200 bg-gold/20 text-white font-bold">סיכומים</a>
                    <a href="user-management.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gold/20 text-gray-200">ניהול משתמשים</a>
                </nav>
            </aside>

            <main class="flex-1 p-4 sm:p-8 min-h-screen">
                <div class="max-w-7xl mx-auto">
                     <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8">
                        <h1 class="text-3xl text-center sm:text-left sm:text-5xl font-bold text-gold">ניהול משימות וסיכומים</h1>
                        <button id="add-task-btn" class="btn-gold font-bold py-2 px-5 rounded-lg flex items-center gap-2 w-full sm:w-auto justify-center">
                            <i class="fas fa-plus-circle"></i>
                            <span>הוספת משימה</span>
                        </button>
                    </div>
                    
                    <div class="mb-8 p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold text-gold mb-3">מקרא צבעים</h3>
                        <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm">
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-green-600 border border-green-400"></div><span>בוצע</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-cyan-600 border border-cyan-400"></div><span>בתהליך</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-red-700 border border-red-500"></div><span>קריטי (1)</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-orange-600 border border-orange-400"></div><span>דחיפות 2</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-yellow-600 border border-yellow-400"></div><span>דחיפות 3</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-blue-600 border border-blue-400"></div><span>דחיפות 4</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-gray-700 border border-gray-500"></div><span>דחיפות 5</span></div>
                        </div>
                    </div>

                    <div id="checklist-container" class="space-y-10"></div>
                    
                    <div id="empty-state" class="hidden text-center py-20">
                         <div class="bg-gray-800/30 border border-gray-700 rounded-xl p-10 max-w-lg mx-auto">
                            <i class="fas fa-folder-open text-6xl text-gold/50 mb-6"></i>
                            <h2 class="text-3xl font-bold text-gray-300 mb-2">הכל מתחיל כאן</h2>
                            <p class="text-gray-400 mb-6">נראה שעדיין אין קטגוריות או משימות. <br>התחל על ידי הוספת משימה חדשה.</p>
                            <button id="add-first-task-btn" class="btn-gold font-bold py-3 px-8 rounded-lg flex items-center gap-2 mx-auto">
                                <i class="fas fa-plus-circle"></i>
                                <span>הוסף משימה ראשונה</span>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="task-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-md rounded-lg shadow-2xl shadow-gold/20">
            <form id="task-form" class="p-6 sm:p-8">
                <h2 id="task-modal-title" class="text-2xl sm:text-3xl font-bold text-gold mb-6 text-center">הוספת משימה</h2>
                <input type="hidden" id="task-id">
                
                <div id="task-page-1" class="space-y-5">
                    <div>
                        <label for="task-category" class="block text-sm font-medium text-gray-300 mb-2">קטגוריה</label>
                        <div class="flex gap-2"><select id="task-category" class="select-field flex-grow" required></select><button type="button" id="edit-categories-btn" class="p-2 bg-gray-600 rounded-md hover:bg-gray-500" title="עריכת קטגוריות"><i class="fas fa-edit"></i></button></div>
                    </div>
                    <div><label for="task-name" class="block text-sm font-medium text-gray-300 mb-1">שם המשימה</label><input type="text" id="task-name" class="input-field" required><p id="task-name-error" class="text-red-400 text-sm mt-1 hidden">שדה זה הוא חובה.</p></div>
                    <div><label for="task-urgency" class="block text-sm font-medium text-gray-300 mb-1">רמת דחיפות</label><select id="task-urgency" class="select-field"><option value="1">1 - קריטי</option><option value="2">2 - גבוהה</option><option value="3" selected>3 - רגילה</option><option value="4">4 - נמוכה</option><option value="5">5 - נמוכה מאוד</option></select></div>
                    <div class="flex justify-between gap-4 pt-4">
                        <button type="button" id="cancel-task-btn-page1" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 w-1/2">ביטול</button>
                        <button type="button" id="next-task-page-btn" class="btn-gold font-bold py-2 px-6 rounded-lg w-1/2">הבא</button>
                    </div>
                </div>

                <div id="task-page-2" class="hidden space-y-5">
                    <div><label for="task-deadline" class="block text-sm font-medium text-gray-300 mb-1">דדליין</label><input type="text" id="task-deadline" class="input-field" placeholder="לדוגמא: ספטמבר 2025"></div>
                    <div><label for="task-contact" class="block text-sm font-medium text-gray-300 mb-1">איש קשר</label><input type="text" id="task-contact" class="input-field" placeholder="שם וטלפון (אופציונלי)"></div>
                    <div><label for="task-details" class="block text-sm font-medium text-gray-300 mb-1">פירוט נוסף</label><textarea id="task-details" rows="3" class="textarea-field"></textarea></div>
                    <div class="flex justify-between gap-4 pt-4">
                        <button type="button" id="back-task-page-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 w-1/2">חזור</button>
                        <button type="submit" class="btn-gold font-bold py-2 px-6 rounded-lg w-1/2">שמור</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="update-status-modal" class="modal fixed inset-0 z-[51] items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-md rounded-lg shadow-2xl shadow-gold/20 max-h-[90vh] overflow-y-auto">
             <div class="p-6 sm:p-8">
                <h2 id="update-modal-title" class="text-2xl font-bold text-gold mb-4 text-center break-words"></h2>
                <div id="task-details-display" class="mb-4 p-3 bg-gray-800/50 rounded-lg space-y-1 text-xs border border-gray-700"></div>

                <div class="space-y-4 mb-4">
                    <div><label class="block text-sm font-medium text-gray-400 mb-1">סטטוס</label>
                        <div class="grid grid-cols-3 gap-2 sm:gap-4">
                            <button data-status="done" class="status-btn bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-500 flex items-center justify-center gap-2 text-sm"><i class="fas fa-check-circle"></i><span class="hidden sm:inline">בוצע</span></button>
                            <button data-status="progress" class="status-btn bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-500 flex items-center justify-center gap-2 text-sm"><i class="fas fa-tasks"></i><span class="hidden sm:inline">בתהליך</span></button>
                            <button data-status="" class="status-btn bg-red-700 text-white font-bold py-3 rounded-lg hover:bg-red-500 flex items-center justify-center gap-2 text-sm"><i class="fas fa-times-circle"></i><span class="hidden sm:inline">לא בוצע</span></button>
                        </div>
                    </div>
                     <div><label for="update-assigned-to" class="block text-sm font-medium text-gray-400">אחראי</label><input type="text" id="update-assigned-to" class="input-field mt-1"></div>
                     <div><label for="update-details" class="block text-sm font-medium text-gray-400">פירוט עדכון</label><textarea id="update-details" rows="2" class="textarea-field mt-1"></textarea></div>
                </div>
                 
                <div class="space-y-3 mt-6">
                    <button type="button" id="save-update-btn" class="w-full btn-gold font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2"><i class="fas fa-save"></i><span>שמור שינויים</span></button>
                    <button type="button" id="edit-task-from-status-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-500 flex items-center justify-center gap-2"><i class="fas fa-edit"></i><span>ערוך משימה</span></button>
                    <button type="button" id="cancel-update-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">סגור</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Management Modals -->
    <div id="edit-categories-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-md rounded-lg shadow-2xl shadow-gold/20"><div class="p-6"><h2 class="text-2xl font-bold text-gold mb-4">ניהול קטגוריות</h2><div id="category-list" class="space-y-2 max-h-60 overflow-y-auto mb-4 p-1"></div><button type="button" id="close-edit-categories-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors">סגור</button></div></div></div>
    <div id="add-category-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-sm rounded-lg shadow-2xl shadow-gold/20"><form id="add-category-form" class="p-6 space-y-4"><h2 class="text-2xl font-bold text-gold">הוסף קטגוריה</h2><input type="text" id="new-category-name" placeholder="שם הקטגוריה" class="input-field" required><div class="flex gap-4"><button type="button" id="cancel-add-category-btn" class="flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500">ביטול</button><button type="submit" class="flex-1 btn-gold font-bold py-2 px-4 rounded-lg">שמור</button></div></form></div></div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 z-[60] items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-sm rounded-lg shadow-2xl shadow-red-500/20 border-red-500">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h2 class="text-xl font-bold text-white mb-2">אישור מחיקה</h2>
                <p class="text-gray-400 mb-6">פעולה זו תמחק גם את כל המשימות המשויכות לקטגוריה. האם להמשיך?</p>
                <div class="flex gap-4">
                    <button type="button" id="cancel-delete-btn" class="flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500">ביטול</button>
                    <button type="button" id="confirm-delete-btn" class="flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-500">מחק</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = { apiKey: "AIzaSyBK49YH2eqeTLhrvKgIsbg3r53-Wt4PmpQ", authDomain: "sayora-all.firebaseapp.com", projectId: "sayora-all", storageBucket: "sayora-all.appspot.com", messagingSenderId: "836076195583", appId: "1:836076195583:web:a7b0067b866d7e027a06ca", measurementId: "G-LFN43NSE5K" };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appContainer = document.getElementById('app-container');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeMsg = document.getElementById('welcome-msg');
        const checklistContainer = document.getElementById('checklist-container');
        const emptyState = document.getElementById('empty-state');
        const addTaskBtn = document.getElementById('add-task-btn');
        const addFirstTaskBtn = document.getElementById('add-first-task-btn');

        // Modal elements
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const taskModalTitle = document.getElementById('task-modal-title');
        const taskCategorySelect = document.getElementById('task-category');
        const taskPage1 = document.getElementById('task-page-1');
        const taskPage2 = document.getElementById('task-page-2');
        const nextTaskPageBtn = document.getElementById('next-task-page-btn');
        const backTaskPageBtn = document.getElementById('back-task-page-btn');
        const cancelTaskBtnPage1 = document.getElementById('cancel-task-btn-page1');

        const updateStatusModal = document.getElementById('update-status-modal');
        const updateModalTitle = document.getElementById('update-modal-title');
        const editTaskFromStatusBtn = document.getElementById('edit-task-from-status-btn');
        const taskDetailsDisplay = document.getElementById('task-details-display');
        const saveUpdateBtn = document.getElementById('save-update-btn');
        const cancelUpdateBtn = document.getElementById('cancel-update-btn');
        
        const editCategoriesBtn = document.getElementById('edit-categories-btn');
        const editCategoriesModal = document.getElementById('edit-categories-modal');
        const addCategoryModal = document.getElementById('add-category-modal');
        const closeEditCategoriesBtn = document.getElementById('close-edit-categories-btn');
        const addCategoryForm = document.getElementById('add-category-form');
        const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');

        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        let categories = [];
        let tasks = [];
        let currentTaskIdForStatusUpdate = null;
        let categoryIdToDelete = null;
        let selectedStatus = '';

        onAuthStateChanged(auth, user => {
            if (user) {
                appContainer.classList.remove('hidden');
                welcomeMsg.textContent = `ברוך הבא, ${user.email.split('@')[0]}`;
                loadData();
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        function loadData() {
            onSnapshot(collection(db, 'checklistCategories'), (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name, 'he'));
                updateCategorySelect();
                renderChecklists();
            });

            onSnapshot(collection(db, 'checklistItems'), (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChecklists();
            });
        }

        function renderChecklists() {
            if (categories.length === 0) {
                checklistContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');
            
            checklistContainer.innerHTML = '';
            categories.forEach(category => {
                const categoryTasks = tasks.filter(task => task.category === category.name).sort((a, b) => a.urgency - b.urgency || a.name.localeCompare(b.name, 'he'));
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h2 class="text-2xl sm:text-3xl font-bold text-gold mb-4 border-b-2 border-gold/30 pb-2">${category.name}</h2>`;
                if(categoryTasks.length > 0) {
                    const tasksGrid = document.createElement('div');
                    tasksGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                    categoryTasks.forEach(task => tasksGrid.appendChild(createTaskElement(task)));
                    categoryDiv.appendChild(tasksGrid);
                } else {
                    categoryDiv.innerHTML += `<p class="text-gray-500 italic">אין משימות בקטגוריה זו.</p>`;
                }
                checklistContainer.appendChild(categoryDiv);
            });
        }

        function getStatusInfo(status) {
            switch (status) {
                case 'done': return { text: 'בוצע', color: 'bg-green-600/80 border-green-400', icon: 'fa-check-circle' };
                case 'progress': return { text: 'בתהליך', color: 'bg-cyan-600/80 border-cyan-400', icon: 'fa-tasks' };
                default: return { text: 'לא בוצע', color: '', icon: 'fa-clock' };
            }
        }
        
        function getUrgencyColor(urgency, status) {
             if (status === 'done' || status === 'progress') return '';
            switch (parseInt(urgency)) {
                case 1: return 'bg-red-700/80 border-red-500';
                case 2: return 'bg-orange-600/80 border-orange-400';
                case 3: return 'bg-yellow-600/80 border-yellow-400';
                case 4: return 'bg-blue-600/80 border-blue-400';
                default: return 'bg-gray-700/80 border-gray-500';
            }
        }

        function createTaskElement(task) {
            const el = document.createElement('div');
            const statusInfo = getStatusInfo(task.status);
            const urgencyColor = getUrgencyColor(task.urgency, task.status);
            el.className = `task-item p-4 rounded-lg border-l-4 cursor-pointer flex flex-col justify-between bg-gray-800/40 ${statusInfo.color || urgencyColor}`;
            el.dataset.id = task.id;
            el.innerHTML = `
                <div>
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg sm:text-xl font-bold mb-2 break-words">${task.name}</h3>
                        <span class="text-xs font-bold py-1 px-2 rounded-full flex-shrink-0 ml-2 ${urgencyColor || 'bg-gray-600'}">${task.urgency}</span>
                    </div>
                    ${task.deadline ? `<p class="text-sm text-gray-300 mb-2"><i class="fas fa-calendar-alt fa-fw mr-2"></i>${task.deadline}</p>` : ''}
                    ${task.assignedTo ? `<p class="text-sm text-gray-200 font-semibold mb-2"><i class="fas fa-user-check fa-fw mr-2"></i>${task.assignedTo}</p>`: ''}
                </div>
                <div class="flex justify-start items-center gap-2 text-sm mt-3 pt-3 border-t border-white/20"><i class="fas ${statusInfo.icon} fa-fw"></i><span>${statusInfo.text}</span></div>`;
            el.addEventListener('click', () => openUpdateStatusModal(task.id));
            return el;
        }
        
        function openEditTaskModal(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            closeUpdateStatusModal();
            taskForm.reset();
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-category').value = task.category;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-deadline').value = task.deadline || '';
            document.getElementById('task-urgency').value = task.urgency;
            document.getElementById('task-contact').value = task.contact || '';
            document.getElementById('task-details').value = task.details || '';
            taskModalTitle.textContent = 'עריכת משימה';
            openTaskModal(0); 
        }

        editTaskFromStatusBtn.addEventListener('click', () => {
            if (currentTaskIdForStatusUpdate) openEditTaskModal(currentTaskIdForStatusUpdate);
        });

        function openUpdateStatusModal(id) {
            currentTaskIdForStatusUpdate = id;
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            updateModalTitle.textContent = task.name;
            document.getElementById('update-assigned-to').value = task.assignedTo || '';
            document.getElementById('update-details').value = task.updateDetails || '';
            taskDetailsDisplay.innerHTML = `<p><strong class="text-gray-300">קטגוריה:</strong> ${task.category}</p><p><strong class="text-gray-300">דדליין:</strong> ${task.deadline || 'לא הוגדר'}</p><p><strong class="text-gray-300">איש קשר:</strong> ${task.contact || 'לא הוגדר'}</p>`;
            
            selectedStatus = task.status || '';
            updateStatusButtonsUI();

            updateStatusModal.classList.add('flex');
        }
        
        function updateStatusButtonsUI() {
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.status === selectedStatus);
            });
        }

        updateStatusModal.querySelectorAll('.status-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                selectedStatus = btn.dataset.status;
                updateStatusButtonsUI();
            });
        });

        saveUpdateBtn.addEventListener('click', async () => {
            if (!currentTaskIdForStatusUpdate) return;
            const assignedTo = document.getElementById('update-assigned-to').value;
            const updateDetails = document.getElementById('update-details').value;
            const taskRef = doc(db, 'checklistItems', currentTaskIdForStatusUpdate);
            await updateDoc(taskRef, { status: selectedStatus, assignedTo, updateDetails });
            closeUpdateStatusModal();
        });

        function openTaskModal(page = 0) {
            taskPage1.classList.toggle('hidden', page === 1);
            taskPage2.classList.toggle('hidden', page === 0);
            taskModal.classList.add('flex');
        }
        
        const handleAddTaskClick = () => {
            taskForm.reset();
            document.getElementById('task-id').value = '';
            taskModalTitle.textContent = 'הוספת משימה חדשה';
            openTaskModal(0);
        };
        
        addTaskBtn.addEventListener('click', handleAddTaskClick);
        addFirstTaskBtn.addEventListener('click', handleAddTaskClick);

        taskForm.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('task-id').value;
            const taskData = {
                category: document.getElementById('task-category').value,
                name: document.getElementById('task-name').value,
                urgency: parseInt(document.getElementById('task-urgency').value),
                deadline: document.getElementById('task-deadline').value,
                contact: document.getElementById('task-contact').value,
                details: document.getElementById('task-details').value,
            };
            
            if (id) {
                await updateDoc(doc(db, 'checklistItems', id), taskData);
            } else {
                taskData.status = ''; taskData.assignedTo = ''; taskData.updateDetails = '';
                await addDoc(collection(db, 'checklistItems'), taskData);
            }
            closeTaskModal();
        });

        nextTaskPageBtn.addEventListener('click', () => {
            const taskNameInput = document.getElementById('task-name');
            const errorEl = document.getElementById('task-name-error');
            if (taskNameInput.value.trim() === '') {
                taskNameInput.classList.add('border-red-500');
                errorEl.classList.remove('hidden');
                return;
            }
            taskNameInput.classList.remove('border-red-500');
            errorEl.classList.add('hidden');
            taskPage1.classList.add('hidden');
            taskPage2.classList.remove('hidden');
        });
        backTaskPageBtn.addEventListener('click', () => {
            taskPage2.classList.add('hidden');
            taskPage1.classList.remove('hidden');
        });

        function updateCategorySelect() {
            taskCategorySelect.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            taskCategorySelect.innerHTML += '<option value="add_new_category" class="text-gold font-bold">-- הוסף קטגוריה --</option>';
        }

        taskCategorySelect.addEventListener('change', (e) => {
            if (e.target.value === 'add_new_category') { e.target.selectedIndex = 0; openAddCategoryModal(); }
        });
        
        editCategoriesBtn.addEventListener('click', () => {
            const categoryList = document.getElementById('category-list');
            categoryList.innerHTML = categories.map(c => `<div class="flex justify-between items-center p-2 bg-gray-700 rounded-md"><span>${c.name}</span><button data-id="${c.id}" class="delete-category-btn text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button></div>`).join('');
            document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => {
                categoryIdToDelete = e.currentTarget.dataset.id;
                deleteConfirmModal.classList.add('flex');
            }));
            openEditCategoriesModal();
        });
        
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!categoryIdToDelete) return;

            const categoryToDelete = categories.find(c => c.id === categoryIdToDelete);
            if (!categoryToDelete) return;

            const tasksToDelete = tasks.filter(t => t.category === categoryToDelete.name);
            const batch = writeBatch(db);
            tasksToDelete.forEach(task => batch.delete(doc(db, 'checklistItems', task.id)));
            batch.delete(doc(db, 'checklistCategories', categoryIdToDelete));
            await batch.commit();

            categoryIdToDelete = null;
            deleteConfirmModal.classList.remove('flex');
        });

        addCategoryForm.addEventListener('submit', async e => {
            e.preventDefault();
            const newName = document.getElementById('new-category-name').value.trim();
            if (newName && !categories.some(c => c.name === newName)) {
                await addDoc(collection(db, 'checklistCategories'), { name: newName });
            }
            closeAddCategoryModal();
            document.getElementById('new-category-name').value = '';
        });
        
        function closeTaskModal() { taskModal.classList.remove('flex'); }
        function closeUpdateStatusModal() { updateStatusModal.classList.remove('flex'); }
        function openEditCategoriesModal() { editCategoriesModal.classList.add('flex'); }
        function closeEditCategoriesModal() { editCategoriesModal.classList.remove('flex'); }
        function openAddCategoryModal() { addCategoryModal.classList.add('flex'); }
        function closeAddCategoryModal() { addCategoryModal.classList.remove('flex'); }
        function closeDeleteConfirmModal() { deleteConfirmModal.classList.remove('flex'); }

        cancelTaskBtnPage1.addEventListener('click', closeTaskModal);
        cancelUpdateBtn.addEventListener('click', closeUpdateStatusModal);
        closeEditCategoriesBtn.addEventListener('click', closeEditCategoriesModal);
        cancelAddCategoryBtn.addEventListener('click', closeAddCategoryModal);
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
        
        const hamburgerBtn = document.getElementById('hamburger-btn'), closeSidebarBtn = document.getElementById('close-sidebar-btn'), sidebar = document.getElementById('sidebar'), sidebarOverlay = document.getElementById('sidebar-overlay');
        const openSidebar = () => { sidebar.classList.add('open'); sidebarOverlay.classList.remove('hidden'); }, closeSidebar = () => { sidebar.classList.remove('open'); sidebarOverlay.classList.add('hidden'); };
        hamburgerBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
    </script>
</body>
</html>

